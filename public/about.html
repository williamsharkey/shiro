<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shiro — Browser OS</title>
  <meta name="description" content="A Unix shell that runs in a browser tab. 150 commands, persistent files, git, npm, live web servers — all in one HTML file.">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0a0a0a;
      color: #999;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    a { color: #7eb8c9; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .page {
      max-width: 740px;
      margin: 0 auto;
      padding: 60px 24px 80px;
    }

    /* Header */
    .header {
      margin-bottom: 64px;
    }

    .header h1 {
      font-size: 2.4rem;
      font-weight: 600;
      color: #f0f0f0;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .header .subtitle {
      font-size: 1.1rem;
      color: #666;
      max-width: 520px;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 32px;
      font-size: 0.85rem;
      color: #555;
    }
    .back-link:hover { color: #888; text-decoration: none; }

    /* Demo cards */
    .demo-card {
      margin-bottom: 56px;
    }

    .demo-card h2 {
      font-size: 1.15rem;
      font-weight: 500;
      color: #ccc;
      margin-bottom: 12px;
    }

    .demo-card .card-desc {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 12px;
    }

    /* Terminal */
    .demo-terminal {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      font-family: "SF Mono", "Fira Code", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.82rem;
      line-height: 1.55;
      overflow: hidden;
      position: relative;
    }

    .demo-terminal .term-body {
      padding: 14px 16px;
      max-height: 400px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .demo-terminal .term-body::-webkit-scrollbar { width: 6px; }
    .demo-terminal .term-body::-webkit-scrollbar-track { background: transparent; }
    .demo-terminal .term-body::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    .term-line { white-space: pre-wrap; word-break: break-all; }
    .term-prompt { color: #58a6ff; }
    .term-cmd { color: #e6e6e6; }
    .term-output { color: #8b949e; }
    .term-note {
      color: #58a6ff;
      font-style: italic;
      opacity: 0.7;
      display: block;
      margin: 4px 0 2px;
    }

    .term-cursor {
      display: inline-block;
      width: 7px;
      height: 14px;
      background: #58a6ff;
      vertical-align: text-bottom;
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    /* Controls */
    .demo-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #0d0d0d;
      border-top: 1px solid #1a1a1a;
    }

    .demo-controls button {
      padding: 4px 14px;
      font-size: 0.72rem;
      font-family: "SF Mono", monospace;
      background: #1a1a1a;
      color: #888;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      transition: all 0.15s;
    }

    .demo-controls button:hover {
      background: #252525;
      color: #bbb;
    }

    .demo-controls button.playing {
      color: #58a6ff;
      border-color: #58a6ff44;
    }

    .demo-controls .step-counter {
      font-size: 0.7rem;
      font-family: "SF Mono", monospace;
      color: #444;
      margin-left: auto;
    }

    .demo-controls .speed-btn {
      padding: 4px 8px;
      font-size: 0.68rem;
    }

    .demo-controls .speed-btn.active {
      color: #58a6ff;
      border-color: #58a6ff44;
    }

    /* Preview panel */
    .demo-preview {
      border: 1px solid #222;
      border-top: none;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      background: #fff;
    }

    .demo-preview iframe {
      width: 100%;
      height: 280px;
      border: none;
      display: block;
    }

    .demo-preview .preview-label {
      font-size: 0.65rem;
      font-family: "SF Mono", monospace;
      color: #444;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 12px;
      background: #0d0d0d;
      border-bottom: 1px solid #1a1a1a;
    }

    /* Opus hero section */
    .opus-card {
      margin-top: 80px;
      margin-bottom: 56px;
    }

    .opus-card h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #f0f0f0;
      margin-bottom: 6px;
    }

    .opus-card .opus-sub {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 16px;
    }

    .opus-card .demo-terminal .term-body {
      max-height: 520px;
    }

    /* Footer */
    .footer {
      margin-top: 80px;
      padding-top: 24px;
      border-top: 1px solid #1a1a1a;
      font-size: 0.85rem;
      color: #444;
    }

    .footer a { color: #666; }
    .footer a:hover { color: #999; }

    .footer .links {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .page { padding: 32px 16px 60px; }
      .header h1 { font-size: 1.8rem; }
      .demo-terminal .term-body { font-size: 0.75rem; padding: 10px 12px; }
    }

    /* Hidden shiro iframe */
    #shiro-engine {
      position: fixed;
      width: 1px;
      height: 1px;
      top: -9999px;
      left: -9999px;
      opacity: 0;
      pointer-events: none;
    }

    /* Loading indicator */
    .engine-status {
      font-size: 0.72rem;
      font-family: "SF Mono", monospace;
      color: #333;
      margin-bottom: 48px;
    }
    .engine-status.ready { color: #3fb950; }
    .engine-status.error { color: #f85149; }
  </style>
</head>
<body>
  <div class="page">
    <a href="/" class="back-link">&larr; shiro.computer</a>

    <div class="header">
      <h1>Shiro</h1>
      <p class="subtitle">A Unix shell in a browser tab. Files, pipes, git, npm, live web servers — all in one HTML file. Watch it work.</p>
    </div>

    <div id="engine-status" class="engine-status">loading shiro...</div>

    <!-- Demo 1: Hello -->
    <div class="demo-card" id="demo-hello">
      <h2>Pipes work</h2>
      <div class="demo-terminal">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.hello.play()">Play</button>
          <button onclick="demos.hello.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('hello',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('hello',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('hello',3)">3x</button>
        </div>
      </div>
    </div>

    <!-- Demo 2: Files -->
    <div class="demo-card" id="demo-files">
      <h2>Files persist in the browser</h2>
      <div class="demo-terminal">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.files.play()">Play</button>
          <button onclick="demos.files.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('files',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('files',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('files',3)">3x</button>
        </div>
      </div>
    </div>

    <!-- Demo 3: Text Processing -->
    <div class="demo-card" id="demo-text">
      <h2>grep, sort, cut, awk</h2>
      <div class="demo-terminal">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.text.play()">Play</button>
          <button onclick="demos.text.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('text',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('text',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('text',3)">3x</button>
        </div>
      </div>
    </div>

    <!-- Demo 4: Git -->
    <div class="demo-card" id="demo-git">
      <h2>Git works</h2>
      <div class="demo-terminal">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.git.play()">Play</button>
          <button onclick="demos.git.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('git',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('git',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('git',3)">3x</button>
        </div>
      </div>
    </div>

    <!-- Demo 5: Build a Web Page -->
    <div class="demo-card" id="demo-web">
      <h2>Build a web page</h2>
      <p class="card-desc">Write HTML and CSS, serve it live, edit it in place.</p>
      <div class="demo-terminal" style="border-radius: 8px 8px 0 0;">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.web.play()">Play</button>
          <button onclick="demos.web.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('web',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('web',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('web',3)">3x</button>
        </div>
      </div>
      <div class="demo-preview">
        <div class="preview-label">preview</div>
        <iframe id="preview-web"></iframe>
      </div>
    </div>

    <!-- Demo 6: Todo App -->
    <div class="demo-card" id="demo-todo">
      <h2>Build a todo app</h2>
      <p class="card-desc">Write an interactive app, serve it, interact with it, add features live.</p>
      <div class="demo-terminal" style="border-radius: 8px 8px 0 0;">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.todo.play()">Play</button>
          <button onclick="demos.todo.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('todo',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('todo',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('todo',3)">3x</button>
        </div>
      </div>
      <div class="demo-preview">
        <div class="preview-label">preview</div>
        <iframe id="preview-todo"></iframe>
      </div>
    </div>

    <!-- Demo 7: The Opus -->
    <div class="demo-card opus-card" id="demo-opus">
      <h2>The Opus</h2>
      <p class="opus-sub">Full dev cycle — scaffold, serve, interact, git commit, add features, ship.</p>
      <div class="demo-terminal" style="border-radius: 8px 8px 0 0;">
        <div class="term-body"></div>
        <div class="demo-controls">
          <button class="play-btn" onclick="demos.opus.play()">Play</button>
          <button onclick="demos.opus.reset()">Reset</button>
          <span class="step-counter"></span>
          <button class="speed-btn active" onclick="setSpeed('opus',1)">1x</button>
          <button class="speed-btn" onclick="setSpeed('opus',2)">2x</button>
          <button class="speed-btn" onclick="setSpeed('opus',3)">3x</button>
        </div>
      </div>
      <div class="demo-preview">
        <div class="preview-label">preview</div>
        <iframe id="preview-opus"></iframe>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div class="links">
        <a href="https://github.com/williamsharkey/shiro">source</a>
        <a href="https://github.com/williamsharkey/fluffycoreutils">fluffycoreutils</a>
        <a href="https://github.com/williamsharkey/foam">foam</a>
        <a href="https://github.com/williamsharkey/spirit">spirit</a>
      </div>
      <p>William Sharkey &middot; 2026</p>
    </div>
  </div>

  <!-- Hidden Shiro engine -->
  <iframe id="shiro-engine" src="/"></iframe>

  <script>
  // ===== Helpers =====
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  let shiroReady = false;

  function getShiro() {
    const iframe = document.getElementById('shiro-engine');
    return iframe?.contentWindow?.__shiro;
  }

  async function waitForShiro(timeout = 20000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      try {
        if (getShiro()?.shell?.exec) {
          shiroReady = true;
          const el = document.getElementById('engine-status');
          el.textContent = 'shiro ready';
          el.classList.add('ready');
          return;
        }
      } catch {}
      await sleep(200);
    }
    const el = document.getElementById('engine-status');
    el.textContent = 'shiro failed to load';
    el.classList.add('error');
    throw new Error('Shiro boot timeout');
  }

  // ===== DemoPlayer =====
  class DemoPlayer {
    constructor(cardId, steps, options = {}) {
      this.cardId = cardId;
      this.steps = steps;
      this.hasPreview = options.hasPreview || false;
      this.previewId = options.previewId || null;
      this.previewFiles = options.previewFiles || [];

      this.el = document.getElementById(cardId);
      this.termBody = this.el.querySelector('.term-body');
      this.playBtn = this.el.querySelector('.play-btn');
      this.stepCounter = this.el.querySelector('.step-counter');

      this.currentStep = 0;
      this.playing = false;
      this.paused = false;
      this.speed = 1;
      this.aborted = false;
    }

    async play() {
      if (this.playing && !this.paused) {
        // Pause
        this.paused = true;
        this.playBtn.textContent = 'Resume';
        this.playBtn.classList.remove('playing');
        return;
      }

      if (this.paused) {
        // Resume
        this.paused = false;
        this.playBtn.textContent = 'Pause';
        this.playBtn.classList.add('playing');
        return;
      }

      if (!shiroReady) {
        this.playBtn.textContent = 'Waiting...';
        try { await waitForShiro(); } catch { this.playBtn.textContent = 'Error'; return; }
      }

      // Start fresh
      this.playing = true;
      this.paused = false;
      this.aborted = false;
      this.currentStep = 0;
      this.termBody.innerHTML = '';
      this.playBtn.textContent = 'Pause';
      this.playBtn.classList.add('playing');

      for (let i = 0; i < this.steps.length; i++) {
        if (this.aborted) break;

        // Wait while paused
        while (this.paused && !this.aborted) await sleep(100);
        if (this.aborted) break;

        this.currentStep = i + 1;
        this.updateCounter();
        await this.runStep(this.steps[i]);
      }

      this.playing = false;
      this.paused = false;
      this.playBtn.textContent = 'Replay';
      this.playBtn.classList.remove('playing');
    }

    reset() {
      this.aborted = true;
      this.playing = false;
      this.paused = false;
      this.currentStep = 0;
      this.termBody.innerHTML = '';
      this.playBtn.textContent = 'Play';
      this.playBtn.classList.remove('playing');
      this.updateCounter();
      if (this.hasPreview && this.previewId) {
        document.getElementById(this.previewId).srcdoc = '';
      }
    }

    updateCounter() {
      if (this.currentStep === 0) {
        this.stepCounter.textContent = '';
      } else {
        this.stepCounter.textContent = `Step ${this.currentStep}/${this.steps.length}`;
      }
    }

    async runStep(step) {
      const delay = (step.delay ?? 600) / this.speed;

      // Show note if present
      if (step.note) {
        const noteEl = document.createElement('span');
        noteEl.className = 'term-note';
        noteEl.textContent = '# ' + step.note;
        this.termBody.appendChild(noteEl);
        this.scrollToBottom();
        await sleep(Math.min(400, delay) / this.speed);
      }

      if (step.js) {
        // Execute JS in preview iframe
        await this.runPreviewJS(step.js);
        if (step.preview) await this.updatePreview();
        await sleep(delay);
        return;
      }

      if (!step.cmd) {
        await sleep(delay);
        return;
      }

      // Type the command
      await this.typeCommand(step.cmd);

      // Execute in Shiro
      const output = await this.execInShiro(step.cmd);

      // Show output
      if (output.trim()) {
        await this.showOutput(output);
      }

      // Update preview if needed
      if (step.preview && this.hasPreview) {
        await this.updatePreview();
      }

      await sleep(delay);
    }

    async typeCommand(cmd) {
      const lineEl = document.createElement('div');
      lineEl.className = 'term-line';

      const promptSpan = document.createElement('span');
      promptSpan.className = 'term-prompt';
      promptSpan.textContent = '~ $ ';
      lineEl.appendChild(promptSpan);

      const cmdSpan = document.createElement('span');
      cmdSpan.className = 'term-cmd';
      lineEl.appendChild(cmdSpan);

      const cursor = document.createElement('span');
      cursor.className = 'term-cursor';
      lineEl.appendChild(cursor);

      this.termBody.appendChild(lineEl);
      this.scrollToBottom();

      // Type char by char
      const charDelay = 35 / this.speed;
      for (let i = 0; i < cmd.length; i++) {
        if (this.aborted) break;
        while (this.paused && !this.aborted) await sleep(50);
        cmdSpan.textContent += cmd[i];
        this.scrollToBottom();
        await sleep(charDelay);
      }

      // Remove cursor after typing
      cursor.remove();
    }

    async showOutput(text) {
      const lines = text.replace(/\n$/, '').split('\n');
      const lineDelay = 30 / this.speed;

      for (const line of lines) {
        if (this.aborted) break;
        const lineEl = document.createElement('div');
        lineEl.className = 'term-line term-output';
        lineEl.textContent = line;
        this.termBody.appendChild(lineEl);
        this.scrollToBottom();
        await sleep(lineDelay);
      }
    }

    async execInShiro(cmd) {
      try {
        const shiro = getShiro();
        const result = await shiro.shell.exec(cmd);
        let out = '';
        if (result?.stdout) out += result.stdout;
        if (result?.stderr) out += result.stderr;
        return out;
      } catch (e) {
        return '';
      }
    }

    async updatePreview() {
      if (!this.previewId || !this.previewFiles.length) return;
      try {
        const shiro = getShiro();
        let html = '';
        let css = '';
        let js = '';

        for (const f of this.previewFiles) {
          try {
            const content = await shiro.shell.exec('cat ' + f);
            const text = content?.stdout || '';
            if (f.endsWith('.html')) html = text;
            else if (f.endsWith('.css')) css = text;
            else if (f.endsWith('.js')) js = text;
          } catch {}
        }

        // Inline CSS and JS into HTML for srcdoc
        if (css && html.includes('</head>')) {
          html = html.replace('</head>', '<style>' + css + '</style></head>');
        }
        if (js && html.includes('</body>')) {
          html = html.replace('</body>', '<script>' + js + '<\/script></body>');
        }

        const iframe = document.getElementById(this.previewId);
        iframe.srcdoc = html;
      } catch {}
    }

    async runPreviewJS(code) {
      try {
        const iframe = document.getElementById(this.previewId);
        if (iframe?.contentWindow) {
          iframe.contentWindow.eval(code);
        }
      } catch {}
      // Small pause for DOM update
      await sleep(200 / this.speed);
    }

    scrollToBottom() {
      this.termBody.scrollTop = this.termBody.scrollHeight;
    }
  }

  // ===== Speed Control =====
  const demos = {};

  function setSpeed(demoKey, speed) {
    const player = demos[demoKey];
    if (!player) return;
    player.speed = speed;

    // Update button states
    const card = player.el;
    card.querySelectorAll('.speed-btn').forEach(btn => {
      btn.classList.toggle('active', btn.textContent === speed + 'x');
    });
  }

  // ===== Demo Definitions =====

  // Demo 1: Hello
  const helloSteps = [
    { cmd: 'echo "hello world"', note: 'Print text' },
    { cmd: 'echo "hello world" | wc -c', note: 'Pipe to word count' },
    { cmd: 'echo "hello world" | sed \'s/world/browser/\'', note: 'Transform with sed' },
  ];

  // Demo 2: Files
  const filesSteps = [
    { cmd: 'mkdir -p /tmp/demo-fs/src /tmp/demo-fs/docs', note: 'Create a project structure' },
    { cmd: 'echo \'console.log("hi")\' > /tmp/demo-fs/src/app.js' },
    { cmd: 'echo \'# My Project\' > /tmp/demo-fs/docs/README.md' },
    { cmd: 'find /tmp/demo-fs -type f', note: 'Find all files' },
    { cmd: 'cat /tmp/demo-fs/src/app.js' },
  ];

  // Demo 3: Text Processing
  const textSteps = [
    { cmd: "printf 'alice,95\\nbob,87\\ncarol,92\\nalice,88\\nbob,91\\n' > /tmp/grades.csv", note: 'Create a CSV file' },
    { cmd: 'cat /tmp/grades.csv' },
    { cmd: 'grep alice /tmp/grades.csv', note: 'Filter rows' },
    { cmd: 'sort /tmp/grades.csv', note: 'Sort' },
    { cmd: 'cut -d, -f2 /tmp/grades.csv | sort -n', note: 'Extract and sort scores' },
    { cmd: "awk -F, '{s[$1]+=$2;n[$1]++} END {for(k in s) printf \"%s: %.0f\\n\",k,s[k]/n[k]}' /tmp/grades.csv", note: 'Compute averages with awk' },
  ];

  // Demo 4: Git Workflow
  const gitSteps = [
    { cmd: 'rm -rf /tmp/myrepo; mkdir -p /tmp/myrepo', note: 'Create a project' },
    { cmd: 'cd /tmp/myrepo && git init' },
    { cmd: 'echo "# Todo App" > /tmp/myrepo/README.md' },
    { cmd: 'echo \'console.log("v1")\' > /tmp/myrepo/app.js' },
    { cmd: 'cd /tmp/myrepo && git add .' },
    { cmd: 'cd /tmp/myrepo && git commit -m "initial commit"', note: 'First commit' },
    { cmd: 'echo \'console.log("v2 — added features")\' > /tmp/myrepo/app.js', note: 'Edit a file' },
    { cmd: 'cd /tmp/myrepo && git diff' },
  ];

  // Demo 5: Build a Web Page
  const webSteps = [
    { cmd: 'mkdir -p /tmp/site' },
    { cmd: "cat > /tmp/site/index.html << 'HEREDOC'\n<!DOCTYPE html>\n<html><head><meta charset=\"utf-8\"><title>My Website</title>\n<link rel=\"stylesheet\" href=\"style.css\"></head>\n<body>\n<h1>My Website</h1>\n<p>Built inside a browser.</p>\n<ul><li>No server</li><li>No build tools</li><li>Just a shell</li></ul>\n</body></html>\nHEREDOC", note: 'Write HTML' },
    { cmd: "cat > /tmp/site/style.css << 'HEREDOC'\nbody { font-family: system-ui; background: #1a1a2e; color: #eee;\n  display: flex; justify-content: center; align-items: center;\n  min-height: 100vh; margin: 0; }\nbody > * { text-align: center; }\nh1 { color: #e94560; margin-bottom: 0.5em; }\nul { list-style: none; padding: 0; }\nli { padding: 4px 0; color: #aaa; }\nHEREDOC", note: 'Write CSS' },
    { cmd: 'cat /tmp/site/index.html' },
    { cmd: 'serve /tmp/site 3000', preview: true, note: 'Serve it', delay: 1000 },
    { note: 'Modify it live' },
    { cmd: "sed -i 's/My Website/My Website ✨/' /tmp/site/index.html" },
    { cmd: 'cat /tmp/site/index.html', preview: true },
    { cmd: 'serve stop 3000', delay: 300 },
  ];

  // Demo 6: Todo App
  const todoHTML = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Todo</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui; background: #16213e; color: #eee;
  display: flex; justify-content: center; padding-top: 60px; }
.app { width: 340px; }
h1 { font-size: 1.5rem; margin-bottom: 16px; color: #e94560; }
form { display: flex; gap: 8px; margin-bottom: 16px; }
input { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #333;
  background: #0f3460; color: #eee; font-size: 0.9rem; }
button { padding: 8px 16px; border-radius: 6px; border: none;
  background: #e94560; color: #fff; cursor: pointer; font-size: 0.9rem; }
button:hover { background: #c73e54; }
ul { list-style: none; }
li { padding: 10px; margin-bottom: 6px; background: #0f3460;
  border-radius: 6px; display: flex; justify-content: space-between;
  align-items: center; cursor: pointer; }
li.done span { text-decoration: line-through; color: #666; }
li .del { color: #e94560; cursor: pointer; font-weight: bold; }
#clear-btn { display: none; margin-top: 12px; background: #333; font-size: 0.8rem; }
</style></head>
<body><div class="app">
<h1>Todo</h1>
<form onsubmit="addTodo(event)">
  <input id="inp" placeholder="What needs to be done?">
  <button type="submit">Add</button>
</form>
<ul id="list"></ul>
<button id="clear-btn" onclick="clearDone()">Clear completed</button>
</div>
<script>
let todos = [];
function render() {
  const ul = document.getElementById('list');
  ul.innerHTML = '';
  todos.forEach((t, i) => {
    const li = document.createElement('li');
    if (t.done) li.className = 'done';
    li.innerHTML = '<span>' + t.text + '</span><span class="del" onclick="del(event,' + i + ')">×</span>';
    li.onclick = () => { todos[i].done = !todos[i].done; render(); };
    ul.appendChild(li);
  });
  const btn = document.getElementById('clear-btn');
  if (btn) btn.style.display = todos.some(t => t.done) ? 'block' : 'none';
}
function addTodo(e) {
  e.preventDefault();
  const inp = document.getElementById('inp');
  if (inp.value.trim()) { todos.push({ text: inp.value.trim(), done: false }); inp.value = ''; render(); }
}
function del(e, i) { e.stopPropagation(); todos.splice(i, 1); render(); }
function clearDone() { todos = todos.filter(t => !t.done); render(); }
</script></body></html>`;

  const todoSteps = [
    { cmd: 'mkdir -p /tmp/todo' },
    { cmd: "cat > /tmp/todo/index.html << 'ENDDOC'\n" + todoHTML + "\nENDDOC", note: 'Write a todo app' },
    { cmd: 'wc -l /tmp/todo/index.html' },
    { cmd: 'serve /tmp/todo 4000', preview: true, note: 'Serve it', delay: 1000 },
    { js: "document.getElementById('inp').value='Buy groceries';document.querySelector('form').dispatchEvent(new Event('submit',{bubbles:true}))", note: 'Add items' },
    { js: "document.getElementById('inp').value='Write code';document.querySelector('form').dispatchEvent(new Event('submit',{bubbles:true}))" },
    { js: "document.getElementById('inp').value='Deploy app';document.querySelector('form').dispatchEvent(new Event('submit',{bubbles:true}))", preview: true },
    { js: "document.querySelector('li').click()", note: 'Complete a task', preview: true, delay: 800 },
    { js: "document.getElementById('clear-btn').click()", note: 'Clear completed', preview: true, delay: 800 },
    { cmd: 'serve stop 4000', delay: 300 },
  ];

  // Demo 7: The Opus
  const opusHTML = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Counter</title>
<link rel="stylesheet" href="style.css">
</head><body>
<div class="app">
  <h1>Counter</h1>
  <div class="display" id="display">0</div>
  <div class="buttons">
    <button id="dec" onclick="dec()">-</button>
    <button id="inc" onclick="inc()">+</button>
  </div>
</div>
<script src="src/app.js"></script>
</body></html>`;

  const opusCSS = `* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui; background: #0f0f23; color: #eee;
  display: flex; justify-content: center; align-items: center;
  min-height: 100vh; }
.app { text-align: center; }
h1 { font-size: 1.3rem; color: #7eb8c9; margin-bottom: 20px; }
.display { font-size: 4rem; font-weight: 700; margin-bottom: 24px;
  font-variant-numeric: tabular-nums; }
.buttons { display: flex; gap: 12px; justify-content: center; }
button { width: 64px; height: 64px; font-size: 1.5rem; border-radius: 12px;
  border: 2px solid #333; background: #1a1a2e; color: #eee; cursor: pointer;
  transition: all 0.1s; }
button:hover { border-color: #7eb8c9; }
button:active { transform: scale(0.95); }
#reset { width: auto; padding: 0 20px; height: 48px; font-size: 1rem;
  margin-top: 16px; border-color: #444; color: #888; }
#reset:hover { border-color: #e94560; color: #e94560; }`;

  const opusJS = `let count = 0;
function update() { document.getElementById('display').textContent = count; }
function inc() { count++; update(); }
function dec() { count--; update(); }`;

  const opusJSWithReset = `let count = 0;
function update() { document.getElementById('display').textContent = count; }
function inc() { count++; update(); }
function dec() { count--; update(); }
function reset() { count = 0; update(); }`;

  const opusJSWithKeys = `let count = 0;
function update() { document.getElementById('display').textContent = count; }
function inc() { count++; update(); }
function dec() { count--; update(); }
function reset() { count = 0; update(); }
document.addEventListener('keydown', e => {
  if (e.key === '+' || e.key === '=') inc();
  else if (e.key === '-') dec();
  else if (e.key === '0') reset();
});`;

  const opusSteps = [
    // Phase 1: Scaffold
    { cmd: 'rm -rf /tmp/opus; mkdir -p /tmp/opus/src /tmp/opus/public', note: 'Scaffold the project' },
    { cmd: "cat > /tmp/opus/public/index.html << 'EOF'\n" + opusHTML + "\nEOF" },
    { cmd: "cat > /tmp/opus/public/style.css << 'EOF'\n" + opusCSS + "\nEOF" },
    { cmd: "cat > /tmp/opus/src/app.js << 'EOF'\n" + opusJS + "\nEOF" },
    { cmd: 'ls -la /tmp/opus/public /tmp/opus/src' },

    // Phase 2: Serve & Interact
    { cmd: 'serve /tmp/opus/public 5000', preview: true, note: 'Serve it', delay: 1000 },
    { js: "inc(); inc(); inc()", note: 'Click increment 3x', preview: true },
    { js: "dec()", note: 'Click decrement', preview: true },
    { cmd: 'echo "Counter works."' },

    // Phase 3: Git
    { cmd: 'cd /tmp/opus && git init', note: 'Initialize git' },
    { cmd: 'cd /tmp/opus && git add .' },
    { cmd: 'cd /tmp/opus && git commit -m "feat: counter app"' },
    { cmd: 'cd /tmp/opus && git log --oneline' },

    // Phase 4: Edit & Enhance
    { note: 'Adding a reset button' },
    { cmd: "sed -i 's|</div>\\n</div>|</div>\\n  <button id=\"reset\" onclick=\"reset()\">Reset</button>\\n</div>|' /tmp/opus/public/index.html" },
    { cmd: "cat > /tmp/opus/src/app.js << 'EOF'\n" + opusJSWithReset + "\nEOF", note: 'Update app.js with reset' },
    { cmd: 'cat /tmp/opus/src/app.js' },
    { preview: true, note: 'Preview updates', delay: 400 },
    { js: "inc(); inc(); inc(); inc(); inc(); setTimeout(() => reset(), 300)", note: 'Increment 5x, then reset', preview: true, delay: 1200 },
    { cmd: 'cd /tmp/opus && git diff', note: 'See the changes' },
    { cmd: 'cd /tmp/opus && git add . && git commit -m "feat: reset button"' },

    // Phase 5: Keyboard shortcuts
    { note: 'Adding keyboard shortcuts' },
    { cmd: "cat > /tmp/opus/src/app.js << 'EOF'\n" + opusJSWithKeys + "\nEOF" },
    { cmd: 'cat /tmp/opus/src/app.js', preview: true },
    { cmd: 'cd /tmp/opus && git add . && git commit -m "feat: keyboard shortcuts"' },

    // Phase 6: Ship
    { cmd: 'cd /tmp/opus && git log --oneline', note: 'Three commits' },
    { cmd: 'find /tmp/opus -type f | sort' },
    { cmd: 'echo "Scaffolded, served, edited, committed — all in one browser tab."', delay: 1500 },
  ];

  // ===== Initialize =====
  document.addEventListener('DOMContentLoaded', () => {
    demos.hello = new DemoPlayer('demo-hello', helloSteps);
    demos.files = new DemoPlayer('demo-files', filesSteps);
    demos.text = new DemoPlayer('demo-text', textSteps);
    demos.git = new DemoPlayer('demo-git', gitSteps);
    demos.web = new DemoPlayer('demo-web', webSteps, {
      hasPreview: true,
      previewId: 'preview-web',
      previewFiles: ['/tmp/site/index.html', '/tmp/site/style.css'],
    });
    demos.todo = new DemoPlayer('demo-todo', todoSteps, {
      hasPreview: true,
      previewId: 'preview-todo',
      previewFiles: ['/tmp/todo/index.html'],
    });
    demos.opus = new DemoPlayer('demo-opus', opusSteps, {
      hasPreview: true,
      previewId: 'preview-opus',
      previewFiles: ['/tmp/opus/public/index.html', '/tmp/opus/public/style.css', '/tmp/opus/src/app.js'],
    });

    // Boot Shiro engine
    waitForShiro().catch(() => {});
  });
  </script>
</body>
</html>
