<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shiro — Browser OS</title>
  <meta name="description" content="A Unix shell that runs in a browser tab. 150+ commands, persistent files, git, npm, web servers — all in one HTML file.">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #fffff8;
      color: #111;
      font-family: 'Palatino Linotype', Palatino, 'Book Antiqua', Georgia, serif;
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
    }

    article {
      max-width: 740px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    a { color: #3b6e8f; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .back {
      display: inline-block;
      margin-bottom: 32px;
      font-size: 0.85rem;
      color: #999;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .back:hover { color: #666; text-decoration: none; }

    h1 {
      font-size: 2.2rem;
      font-weight: 400;
      margin-bottom: 6px;
      line-height: 1.2;
    }

    .subtitle {
      font-size: 1.05rem;
      color: #555;
      max-width: 540px;
      margin-bottom: 6px;
    }

    .status {
      font-size: 0.72rem;
      font-family: 'SF Mono', Consolas, monospace;
      color: #bbb;
      margin-bottom: 48px;
    }
    .status.ready { color: #3fb950; }
    .status.error { color: #d32f2f; }

    /* Tooltips */
    .noted {
      text-decoration-line: underline;
      text-decoration-style: dotted;
      text-decoration-color: #aaa;
      text-underline-offset: 3px;
      cursor: help;
      position: relative;
    }
    .noted .tip {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: max-content;
      max-width: 320px;
      padding: 8px 12px;
      background: #333;
      color: #eee;
      font-size: 0.76rem;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      border-radius: 4px;
      line-height: 1.45;
      z-index: 100;
      white-space: normal;
      pointer-events: none;
      font-style: normal;
    }
    .noted .tip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #333;
    }
    .noted:hover .tip { display: block; }

    /* Sections */
    section { margin-bottom: 48px; }

    section h2 {
      font-size: 1.15rem;
      font-weight: 400;
      font-style: italic;
    }

    /* Caption bar — fades in above slot after demo completes */
    .demo-caption {
      display: flex;
      align-items: center;
      height: 24px;
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
      margin-bottom: 4px;
    }
    .demo-caption.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .demo-caption .cap-title {
      font-size: 0.78rem;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #888;
      font-weight: 600;
    }
    .demo-caption .cap-desc {
      font-size: 0.74rem;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #bbb;
      margin-left: 6px;
    }
    .demo-caption .cap-replay {
      margin-left: auto;
      background: none;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 1px 8px;
      font-size: 0.65rem;
      color: #aaa;
      cursor: pointer;
      font-family: 'SF Mono', Consolas, monospace;
      transition: all 0.15s;
    }
    .demo-caption .cap-replay:hover { border-color: #999; color: #666; }

    /* Demo slot — holds the shared real terminal iframe */
    .demo-slot {
      height: 320px;
      border-radius: 6px;
      overflow: hidden;
      background: #1a1a2e;
      position: relative;
    }
    .demo-slot iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    .demo-slot-tall { height: 560px; }

    /* YouTube-style overlay */
    .demo-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(15, 15, 30, 0.88);
      z-index: 2;
      cursor: pointer;
      transition: opacity 0.35s ease;
    }
    .demo-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .demo-overlay h2 {
      font-size: 1.5rem;
      font-weight: 400;
      color: #c8c8e0;
      font-style: normal;
      font-family: 'Palatino Linotype', Palatino, 'Book Antiqua', Georgia, serif;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }
    .demo-overlay .overlay-desc {
      font-size: 0.82rem;
      color: #6b6b8a;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin-bottom: 20px;
      text-align: center;
      max-width: 320px;
      line-height: 1.4;
    }
    .demo-play-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 2px solid rgba(200, 200, 224, 0.3);
      background: rgba(200, 200, 224, 0.08);
      color: #c8c8e0;
      font-size: 1.3rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding-left: 3px;
    }
    .demo-play-btn:hover {
      background: rgba(200, 200, 224, 0.18);
      border-color: rgba(200, 200, 224, 0.5);
      transform: scale(1.08);
    }
    .demo-play-btn.loading {
      font-size: 0.65rem;
      font-family: 'SF Mono', Consolas, monospace;
      padding-left: 0;
    }

    /* Preview */
    .preview {
      border: 1px solid #ddd;
      border-radius: 0 0 6px 6px;
      margin-top: -8px;
      overflow: hidden;
      background: #fff;
      position: relative;
    }
    .preview iframe { width: 100%; height: 260px; border: none; display: block; }
    .preview-label {
      font-size: 0.62rem;
      font-family: 'SF Mono', monospace;
      color: #bbb;
      padding: 3px 12px;
      background: #f8f8f2;
      border-bottom: 1px solid #eee;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .preview-overlay {
      position: absolute;
      inset: 0;
      top: 22px; /* below label bar */
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255, 255, 255, 0.85);
      z-index: 2;
      transition: opacity 0.35s ease;
    }
    .preview-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .preview-overlay span {
      font-size: 0.82rem;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #bbb;
    }

    /* Info sections */
    .info-section { margin-top: 64px; margin-bottom: 48px; }
    .info-section h2 {
      font-size: 1.15rem;
      font-weight: 400;
      font-style: italic;
      margin-bottom: 8px;
    }
    .info-section p {
      font-size: 0.9rem;
      color: #444;
      margin-bottom: 8px;
    }
    .info-section code {
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 0.84em;
      background: #f0f0e8;
      padding: 1px 4px;
      border-radius: 2px;
    }

    /* Footer */
    footer {
      margin-top: 72px;
      padding-top: 20px;
      border-top: 1px solid #e0e0d8;
      font-size: 0.82rem;
      color: #999;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    footer .links { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 10px; }
    footer a { color: #999; }
    footer a:hover { color: #666; }

    @media (max-width: 600px) {
      article { padding: 28px 16px 60px; }
      h1 { font-size: 1.8rem; }
      .demo-slot { height: 280px; }
      .demo-overlay h2 { font-size: 1.25rem; }
      .demo-play-btn { width: 48px; height: 48px; font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <article>
    <a href="/" class="back">&larr; shiro.computer</a>

    <h1>Shiro</h1>
    <p class="subtitle">
      A self-contained static webpage that emulates a Unix environment in the browser. It runs <a href="https://docs.anthropic.com/en/docs/claude-code">Claude Code</a> with shimmed versions of the tools Claude commonly uses. Not a real Linux &mdash; but trying to be complete enough for npm, web development, and interacting with served apps in place. Still buggy, still being refined.
    </p>

    <div id="engine-status" class="status">loading shiro&hellip;</div>

    <!-- Demo 1: Pipes -->
    <section id="demo-pipes">
      <div class="demo-caption"><span class="cap-title">Pipes</span><span class="cap-desc">pipes, redirects, and shell plumbing</span><button class="cap-replay" onclick="demos.pipes.reset();demos.pipes.play()">&#8635; replay</button></div>
      <div class="demo-slot">
        <div class="demo-overlay" onclick="demos.pipes.play()">
          <h2>Pipes</h2>
          <p class="overlay-desc">Pipes, redirects, and the usual shell plumbing.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
    </section>

    <!-- Demo 2: Files -->
    <section id="demo-files">
      <div class="demo-caption"><span class="cap-title">Files persist</span><span class="cap-desc">stored in IndexedDB, survives reloads</span><button class="cap-replay" onclick="demos.files.reset();demos.files.play()">&#8635; replay</button></div>
      <div class="demo-slot">
        <div class="demo-overlay" onclick="demos.files.play()">
          <h2>Files persist</h2>
          <p class="overlay-desc">Stored in IndexedDB. Survives page reloads.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
    </section>

    <!-- Demo 3: Text tools -->
    <section id="demo-text">
      <div class="demo-caption"><span class="cap-title">Text tools</span><span class="cap-desc">grep, sort, cut, awk</span><button class="cap-replay" onclick="demos.text.reset();demos.text.play()">&#8635; replay</button></div>
      <div class="demo-slot">
        <div class="demo-overlay" onclick="demos.text.play()">
          <h2>Text tools</h2>
          <p class="overlay-desc">grep, sort, cut, awk &mdash; the standard toolkit.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
    </section>

    <!-- Demo 4: Git -->
    <section id="demo-git">
      <div class="demo-caption"><span class="cap-title">Git</span><span class="cap-desc">local repository operations via isomorphic-git</span><button class="cap-replay" onclick="demos.git.reset();demos.git.play()">&#8635; replay</button></div>
      <div class="demo-slot">
        <div class="demo-overlay" onclick="demos.git.play()">
          <h2>Git</h2>
          <p class="overlay-desc">Local repository operations via isomorphic-git.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
    </section>

    <!-- Demo 5: Serve a page -->
    <section id="demo-page">
      <div class="demo-caption"><span class="cap-title">Serve a page</span><span class="cap-desc">write HTML, serve it, edit in place</span><button class="cap-replay" onclick="demos.page.reset();demos.page.play()">&#8635; replay</button></div>
      <div class="demo-slot" style="border-radius:6px 6px 0 0;margin-bottom:0">
        <div class="demo-overlay" onclick="demos.page.play()">
          <h2>Serve a page</h2>
          <p class="overlay-desc">Write HTML, serve it, edit in place.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
      <div class="preview">
        <div class="preview-label">preview</div>
        <iframe id="preview-page"></iframe>
        <div class="preview-overlay"><span>appears when demo runs</span></div>
      </div>
    </section>

    <!-- Demo 6: Interact with an app -->
    <section id="demo-interact">
      <div class="demo-caption"><span class="cap-title">Interact with an app</span><span class="cap-desc">page command, click &amp; read DOM, then commit</span><button class="cap-replay" onclick="demos.interact.reset();demos.interact.play()">&#8635; replay</button></div>
      <div class="demo-slot demo-slot-tall">
        <div class="demo-overlay" onclick="demos.interact.play()">
          <h2>Interact with an app</h2>
          <p class="overlay-desc">Serve an app, use <code style="color:#8b8bab;background:rgba(255,255,255,0.06);padding:1px 5px;border-radius:3px">page</code> to click and read DOM elements, then commit.</p>
          <button class="demo-play-btn">&#9654;</button>
        </div>
      </div>
    </section>

    <!-- What it is -->
    <section class="info-section">
      <h2>What this is</h2>
      <p>A single HTML file (~350 KB gzipped) with all JS and CSS inlined. Files persist in IndexedDB across reloads. The shell has pipes, redirects, environment variables, and 150+ commands.</p>
      <p><a href="https://docs.anthropic.com/en/docs/claude-code">Claude Code</a> runs inside a Node.js runtime shim. The tools it uses &mdash; file reads, edits, grep, glob, bash &mdash; are shimmed to use the virtual filesystem. Many work, some don't yet. The goal is a browser-native dev environment where an AI agent can read, write, build, and serve code without leaving the tab.</p>
    </section>

    <!-- Isolated filesystems -->
    <section class="info-section">
      <h2>Isolated filesystems</h2>
      <p>Each subdomain is a separate <span class="noted">web origin<span class="tip">The browser's same-origin policy gives each origin its own IndexedDB, localStorage, cookies, and service worker scope.</span></span> with its own storage. Visit <code>app.shiro.computer</code> and you get a clean filesystem. Your files at <code>shiro.computer</code> are untouched.</p>
    </section>

    <!-- Remote -->
    <section class="info-section">
      <h2>Remote control</h2>
      <p>An outer Claude Code instance can control Shiro via <a href="https://modelcontextprotocol.io/">MCP</a> tools over a WebRTC peer-to-peer connection. Run <code>remote start</code> to get a connection code, then use <code>shiro-mcp</code> to exec commands, read/write files, and eval JS in the browser.</p>
    </section>

    <!-- Seed -->
    <section class="info-section">
      <h2>Snapshots</h2>
      <p><code>seed</code> exports the filesystem to the clipboard. Paste it into any browser console to load your files there. <code>seed gif</code> captures a terminal screenshot as a GIF with the filesystem embedded &mdash; drag it back onto Shiro to restore. <code>seed html</code> produces a standalone file you can open anywhere.</p>
    </section>

    <footer>
      <div class="links">
        <a href="https://github.com/williamsharkey/shiro">source</a>
      </div>
      <p>William Sharkey &middot; 2026</p>
    </footer>
  </article>

  <!-- Single shared shiro iframe — moves between demo slots -->
  <iframe id="shiro-live" src="/?demo=1" style="position:fixed;top:-9999px;left:-9999px;width:1px;height:1px;opacity:0"></iframe>

  <script>
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  let shiroReady = false;
  let activeDemo = null;

  function getShiro() {
    const f = document.getElementById('shiro-live');
    return f?.contentWindow?.__shiro;
  }

  async function waitForShiro(timeout = 20000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      try {
        const s = getShiro();
        if (s?.shell?.execute && s?.terminal?.term) {
          shiroReady = true;
          const el = document.getElementById('engine-status');
          el.textContent = 'shiro ready';
          el.classList.add('ready');
          // Always-visible scrollbars for demo terminals
          try {
            const ifrDoc = document.getElementById('shiro-live').contentDocument;
            const sty = ifrDoc.createElement('style');
            sty.textContent = [
              '.xterm .xterm-viewport { overflow-y: scroll !important; }',
              '.xterm .xterm-viewport::-webkit-scrollbar { width: 8px; background: #1a1a2e; }',
              '.xterm .xterm-viewport::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; min-height: 30px; }',
              '.xterm .xterm-viewport::-webkit-scrollbar-thumb:hover { background: #777; }',
            ].join('\n');
            ifrDoc.head.appendChild(sty);
          } catch {}
          return;
        }
      } catch {}
      await sleep(200);
    }
    const el = document.getElementById('engine-status');
    el.textContent = 'failed to load';
    el.classList.add('error');
    throw new Error('Shiro boot timeout');
  }

  // ===== DemoPlayer =====
  class DemoPlayer {
    constructor(id, steps, opts = {}) {
      this.id = id;
      this.steps = steps;
      this.hasPreview = opts.hasPreview || false;
      this.previewId = opts.previewId || null;
      this.previewFiles = opts.previewFiles || [];
      this.el = document.getElementById(id);
      this.slot = this.el.querySelector('.demo-slot');
      this.overlay = this.el.querySelector('.demo-overlay');
      this.playBtn = this.overlay.querySelector('.demo-play-btn');
      this.caption = this.el.querySelector('.demo-caption');
      this.previewOverlay = this.el.querySelector('.preview-overlay');
      this.playing = false;
      this.aborted = false;
    }

    async play() {
      if (this.playing) return; // already running

      // Stop any other playing demo
      if (activeDemo && activeDemo !== this && activeDemo.playing) {
        activeDemo.aborted = true;
        activeDemo.playing = false;
      }
      // If taking iframe from another demo, restore that demo's overlay
      if (activeDemo && activeDemo !== this) {
        activeDemo.showOverlay();
        activeDemo.caption.classList.remove('visible');
      }

      // Move iframe to this demo's slot (appendChild triggers iframe reload!)
      const iframe = document.getElementById('shiro-live');
      const needsMove = iframe.parentElement !== this.slot;
      iframe.style.cssText = 'width:100%;height:100%;border:none;display:block';
      if (needsMove) {
        this.slot.appendChild(iframe);
        shiroReady = false; // iframe reloaded — must re-wait
      }
      activeDemo = this;

      // Wait for shiro to boot (or re-boot after move)
      if (!shiroReady) {
        this.playBtn.textContent = '\u2026';
        this.playBtn.classList.add('loading');
        try { await waitForShiro(); } catch {
          this.playBtn.textContent = '!';
          this.playBtn.classList.remove('loading');
          return;
        }
        this.playBtn.classList.remove('loading');
      }

      // Hide overlay + caption, start playing
      this.overlay.classList.add('hidden');
      this.caption.classList.remove('visible');
      if (this.previewOverlay) this.previewOverlay.classList.add('hidden');
      this.playing = true;
      this.aborted = false;

      // Clear terminal
      const shiro = getShiro();
      const term = shiro.terminal.term;
      term.clear();
      shiro.terminal.fitAddon.fit();

      for (const step of this.steps) {
        if (this.aborted) break;
        await this.runStep(step);
      }

      // Add scroll margin — write blank lines so last command can scroll up
      if (!this.aborted) {
        const halfRows = Math.floor(term.rows / 2);
        term.write('\r\n'.repeat(halfRows));
        term.scrollLines(-halfRows);
      }

      // Hint animation — show the terminal is interactive, then hand over
      if (!this.aborted) await this.showHint();

      this.playing = false;
      // Show caption bar (not overlay) — leave terminal exposed for interaction
      this.caption.classList.add('visible');
    }

    showOverlay() {
      this.overlay.classList.remove('hidden');
      this.playBtn.textContent = '\u25b6';
      this.playBtn.classList.remove('loading');
    }

    async showHint() {
      const shiro = getShiro();
      const term = shiro.terminal.term;
      const hints = [
        '// try something yourself',
        '// the terminal is yours now',
        '// go ahead, type a command',
        '// your turn — try anything',
        '// feel free to explore',
        "// try: echo hello | sed 's/hello/world/'",
        '// end of demo — poke around',
        '// this is a real shell',
        '// try: ls /usr/local/bin',
        '// try: help',
      ];
      const hint = hints[Math.floor(Math.random() * hints.length)];

      // Show prompt
      term.write('\x1b[32muser@shiro\x1b[0m:\x1b[34m~\x1b[0m$ ');
      await sleep(500);
      if (this.aborted) return;

      // Type hint at 4x speed (dim color)
      term.write('\x1b[38;5;242m');
      for (let i = 0; i < hint.length; i++) {
        if (this.aborted) return;
        term.write(hint[i]);
        await sleep(35 / 4);
      }
      term.write('\x1b[0m');
      await sleep(1000);
      if (this.aborted) return;

      // Delete hint at 8x speed
      for (let i = 0; i < hint.length; i++) {
        if (this.aborted) return;
        term.write('\b \b');
        await sleep(35 / 8);
      }

      // Clear the fake prompt line and write a real one directly
      // (don't inject Enter — that writes an extra blank line via writeln(''))
      term.write('\r\x1b[K');
      term.write('\x1b[32muser@shiro\x1b[0m:\x1b[34m~\x1b[0m$ ');
    }

    reset() {
      this.aborted = true;
      this.playing = false;
      this.showOverlay();
      this.caption.classList.remove('visible');
      if (this.previewId) document.getElementById(this.previewId).srcdoc = '';
      if (this.previewOverlay) this.previewOverlay.classList.remove('hidden');
      // Clear terminal if we own it
      if (activeDemo === this) {
        try {
          const term = getShiro().terminal.term;
          term.clear();
        } catch {}
      }
    }

    async runStep(step) {
      const delay = step.delay ?? 300;
      const shiro = getShiro();
      const term = shiro.terminal.term;

      if (step.note) {
        term.write(`\x1b[38;5;75m\x1b[3m# ${step.note}\x1b[0m\r\n`);
        await sleep(200);
      }

      // Simulated page command — types command in terminal, acts on preview iframe
      if (step.sim) {
        await this.typeCommand(term, step.sim.display);
        const pf = this.previewId && document.getElementById(this.previewId);
        const pd = pf?.contentDocument;
        if (pd && step.sim.action === 'text') {
          const el = pd.querySelector(step.sim.sel);
          const text = el?.textContent || '';
          term.write(text + '\r\n');
        } else if (pd && step.sim.action === 'click') {
          const el = pd.querySelector(step.sim.sel);
          if (el) el.click();
        }
        await sleep(delay);
        return;
      }

      if (!step.cmd) {
        if (step.preview && this.hasPreview) await this.updatePreview();
        await sleep(delay);
        return;
      }

      // Type command with animation
      await this.typeCommand(term, step.cmd);

      // Execute command
      let out = '';
      try {
        await shiro.shell.execute(step.cmd, s => { out += s; }, s => { out += s; });
      } catch {}
      if (out.trim()) {
        term.write(out.replace(/\n/g, '\r\n'));
        if (!out.endsWith('\n')) term.write('\r\n');
      }

      if (step.preview && this.hasPreview) await this.updatePreview();
      await sleep(delay);
    }

    async typeCommand(term, cmd) {
      const lines = cmd.split('\n');
      let charPos = 0;

      for (let li = 0; li < lines.length; li++) {
        if (this.aborted) return;
        const line = lines[li];

        if (li === 0) {
          term.write('\x1b[32muser@shiro\x1b[0m:\x1b[34m~\x1b[0m$ ');
        }

        // For heredoc body lines (after first), type fast
        if (li > 0) {
          term.write(line);
          if (li < lines.length - 1) term.write('\r\n');
          await sleep(3);
          continue;
        }

        for (let i = 0; i < line.length; i++) {
          if (this.aborted) return;
          const speed = 4 + 12 * Math.min(charPos / 20, 1);
          term.write(line[i]);
          charPos++;
          await sleep(35 / speed);
        }
        if (li < lines.length - 1) term.write('\r\n');
      }
      term.write('\r\n');
    }

    async updatePreview() {
      if (!this.previewId || !this.previewFiles.length) return;
      try {
        const shiro = getShiro();
        let html = '', css = '', js = '';
        for (const f of this.previewFiles) {
          try {
            let c = '';
            await shiro.shell.execute('cat ' + f, x => c += x, () => {});
            if (f.endsWith('.html')) html = c;
            else if (f.endsWith('.css')) css = c;
            else if (f.endsWith('.js')) js = c;
          } catch {}
        }
        if (css && html.includes('</head>'))
          html = html.replace('</head>', '<style>' + css + '</style></head>');
        if (js && html.includes('</body>'))
          html = html.replace('</body>', '<script>' + js + '<\/script></body>');
        document.getElementById(this.previewId).srcdoc = html;
      } catch {}
    }

  }

  // ===== Demo Definitions =====
  const demos = {};

  const pipesSteps = [
    { cmd: 'echo "hello world"', note: 'Print text' },
    { cmd: 'echo "hello world" | wc -c', note: 'Pipe to word count' },
    { cmd: 'echo "hello world" | sed \'s/world/browser/\'', note: 'Transform with sed' },
  ];

  const filesSteps = [
    { cmd: 'mkdir -p /tmp/project/src /tmp/project/docs', note: 'Create directories' },
    { cmd: 'echo \'console.log("hi")\' > /tmp/project/src/app.js' },
    { cmd: 'echo \'# My Project\' > /tmp/project/docs/README.md' },
    { cmd: 'find /tmp/project -type f', note: 'Find all files' },
    { cmd: 'cat /tmp/project/src/app.js' },
  ];

  const textSteps = [
    { cmd: "printf 'alice,95\\nbob,87\\ncarol,92\\nalice,88\\nbob,91\\n' > /tmp/grades.csv", note: 'Create a CSV' },
    { cmd: 'cat /tmp/grades.csv' },
    { cmd: 'grep alice /tmp/grades.csv', note: 'Filter rows' },
    { cmd: 'sort /tmp/grades.csv', note: 'Sort' },
  ];

  const gitSteps = [
    { cmd: 'rm -rf /tmp/repo; mkdir /tmp/repo', note: 'Create a project' },
    { cmd: 'cd /tmp/repo && git init' },
    { cmd: 'echo "# My App" > /tmp/repo/README.md' },
    { cmd: 'cd /tmp/repo && git add . && git commit -m "initial"', note: 'First commit' },
    { cmd: 'echo "v2" >> /tmp/repo/README.md', note: 'Edit a file' },
    { cmd: 'cd /tmp/repo && git diff' },
  ];

  const pageSteps = [
    { cmd: 'mkdir -p /tmp/site' },
    { cmd: "cat > /tmp/site/index.html << 'EOF'\n<!DOCTYPE html>\n<html><head><title>My Site</title>\n<style>\nbody { font-family: system-ui; background: #1a1a2e; color: #eee;\n  display: flex; justify-content: center; align-items: center;\n  min-height: 100vh; margin: 0; text-align: center; }\nh1 { color: #e94560; }\np { color: #aaa; }\n</style></head>\n<body>\n<div><h1>My Site</h1><p>Built inside a browser.</p></div>\n</body></html>\nEOF", note: 'Write HTML' },
    { cmd: 'serve /tmp/site 3000', preview: true, note: 'Serve it', delay: 800 },
    { cmd: "sed -i 's/My Site/My Site ✨/' /tmp/site/index.html", note: 'Edit in place' },
    { cmd: 'cat /tmp/site/index.html', preview: true },
    { cmd: 'serve stop 3000', delay: 200 },
  ];

  const counterHTML = '<!DOCTYPE html>\n<html><head><title>Counter</title>\n<style>\nbody { font-family: system-ui; background: #0f0f23; color: #eee;\n  display: flex; justify-content: center; align-items: center;\n  min-height: 100vh; margin: 0; }\n.app { text-align: center; }\nh1 { font-size: 1.2rem; color: #7eb8c9; margin-bottom: 20px; }\n.n { font-size: 4rem; font-weight: 700; margin-bottom: 20px;\n  font-variant-numeric: tabular-nums; }\nbutton { width: 56px; height: 56px; font-size: 1.5rem; border-radius: 12px;\n  border: 2px solid #333; background: #1a1a2e; color: #eee;\n  cursor: pointer; margin: 0 6px; }\nbutton:hover { border-color: #7eb8c9; }\n</style></head>\n<body><div class="app">\n  <h1>Counter</h1>\n  <div class="n" id="n">0</div>\n  <button id="dec" onclick="c(-1)">\u2212</button>\n  <button id="inc" onclick="c(1)">+</button>\n</div>\n<' + 'script>\nlet n=0;\nfunction c(d){n+=d;document.getElementById("n").textContent=n}\n<' + '/script>\n</body></html>';

  const grapherHTML = ['<!DOCTYPE html>',
'<html><head><title>Grapher</title>',
'<style>',
'*{box-sizing:border-box;margin:0;padding:0}',
'body{font-family:system-ui;background:#0f0f23;color:#eee;display:flex;justify-content:center;align-items:center;min-height:100vh}',
'.app{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px}',
'h1{font-size:1rem;color:#7eb8c9}',
'.controls{display:flex;flex-direction:column;gap:8px;align-items:center}',
'.axis{display:flex;align-items:center;gap:4px}',
'.axis label{font-size:.75rem;color:#888;width:12px}',
'.axis .val{font-size:1.4rem;font-weight:700;width:3ch;text-align:center;font-variant-numeric:tabular-nums}',
'.axis button{width:32px;height:32px;font-size:1rem;border-radius:8px;border:2px solid #333;background:#1a1a2e;color:#eee;cursor:pointer}',
'.axis button:hover{border-color:#7eb8c9}',
'#plot{width:80px;height:32px;font-size:.75rem;border-radius:8px;border:2px solid #555;background:#2a1a3e;color:#c8b6ff;cursor:pointer;font-weight:600}',
'#plot:hover{border-color:#c8b6ff;background:#3a2a4e}',
'#graph{background:#12122a;border-radius:8px;border:1px solid #222}',
'#pts{font-size:.7rem;color:#555}',
'</style></head>',
'<body><div class="app">',
'<h1>Grapher</h1>',
'<div class="controls">',
'  <div class="axis"><label>x</label><button id="xd" onclick="adj(\'x\',-1)">\u2212</button><span class="val" id="xv">0</span><button id="xu" onclick="adj(\'x\',1)">+</button></div>',
'  <div class="axis"><label>y</label><button id="yd" onclick="adj(\'y\',-1)">\u2212</button><span class="val" id="yv">0</span><button id="yu" onclick="adj(\'y\',1)">+</button></div>',
'  <button id="plot" onclick="plot()">Plot Point</button>',
'</div>',
'<svg id="graph" width="280" height="200"></svg>',
'<div id="pts"></div>',
'</div>',
'<' + 'script>',
'let x=0,y=0,pts=[];',
'function adj(a,d){if(a==="x"){x+=d;document.getElementById("xv").textContent=x}else{y+=d;document.getElementById("yv").textContent=y}}',
'function plot(){pts.push({x,y});draw()}',
'function ticks(mn,mx){let r=mx-mn;if(r<=0)r=1;let s=Math.pow(10,Math.floor(Math.log10(r)));if(r/s<2)s/=5;else if(r/s<5)s/=2;let t=[];for(let v=Math.ceil(mn/s)*s;v<=mx+s*0.001;v+=s)t.push(+v.toFixed(10));return t}',
'function draw(){',
'let svg=document.getElementById("graph"),W=280,H=200,pad={t:12,r:12,b:28,l:34};',
'let xs=pts.map(p=>p.x),ys=pts.map(p=>p.y);',
'let x0=Math.min(0,...xs),x1=Math.max(0,...xs),y0=Math.min(0,...ys),y1=Math.max(0,...ys);',
'if(x0===x1){x0-=1;x1+=1}if(y0===y1){y0-=1;y1+=1}',
'let dx=(x1-x0)*0.08,dy=(y1-y0)*0.08;x0-=dx;x1+=dx;y0-=dy;y1+=dy;',
'let pw=W-pad.l-pad.r,ph=H-pad.t-pad.b;',
'let sx=v=>(v-x0)/(x1-x0)*pw+pad.l,sy=v=>H-pad.b-(v-y0)/(y1-y0)*ph;',
'let h="";',
'h+=\'<line x1="\'+pad.l+\'" y1="\'+sy(0)+\'" x2="\'+(W-pad.r)+\'" y2="\'+sy(0)+\'" stroke="#444"/>\';',
'h+=\'<line x1="\'+sx(0)+\'" y1="\'+pad.t+\'" x2="\'+sx(0)+\'" y2="\'+(H-pad.b)+\'" stroke="#444"/>\';',
'h+=\'<polygon points="\'+(W-pad.r)+","+sy(0)+" "+(W-pad.r-6)+","+(sy(0)-3)+" "+(W-pad.r-6)+","+(sy(0)+3)+\'" fill="#444"/>\';',
'h+=\'<polygon points="\'+sx(0)+","+pad.t+" "+(sx(0)-3)+","+(pad.t+6)+" "+(sx(0)+3)+","+(pad.t+6)+\'" fill="#444"/>\';',
'ticks(x0,x1).forEach(v=>{let px=sx(v);h+=\'<line x1="\'+px+\'" y1="\'+(H-pad.b)+\'" x2="\'+px+\'" y2="\'+(H-pad.b+4)+\'" stroke="#555"/><text x="\'+px+\'" y="\'+(H-pad.b+14)+\'" text-anchor="middle" fill="#666" font-size="9">\'+v+"</text>"});',
'ticks(y0,y1).forEach(v=>{let py=sy(v);h+=\'<line x1="\'+(pad.l-4)+\'" y1="\'+py+\'" x2="\'+pad.l+\'" y2="\'+py+\'" stroke="#555"/><text x="\'+(pad.l-6)+\'" y="\'+(py+3)+\'" text-anchor="end" fill="#666" font-size="9">\'+v+"</text>"});',
'pts.forEach((p,i)=>{h+=\'<circle cx="\'+sx(p.x)+\'" cy="\'+sy(p.y)+\'" r="4" fill="\'+["#ff6b6b","#ffd93d","#6bcb77","#4d96ff","#c8b6ff","#ff922b"][i%6]+\'"/>\';});',
'svg.innerHTML=h;',
'document.getElementById("pts").textContent=pts.length+" point"+(pts.length===1?"":"s");',
'}',
'<' + '/script>',
'</body></html>'].join('\n');

  const interactSteps = [
    { cmd: 'mkdir -p /tmp/counter' },
    { cmd: "cat > /tmp/counter/index.html << 'EOF'\n" + counterHTML + "\nEOF", note: 'Write a counter app' },
    { cmd: 'serve /tmp/counter 5000', note: 'Serve it', delay: 400 },
    { cmd: 'serve open 5000 --split right', delay: 800 },
    { cmd: 'page :5000 text "#n"', note: 'Read the counter value' },
    { cmd: 'page :5000 click "#inc"', note: 'Click the + button' },
    { cmd: 'page :5000 click "#inc"' },
    { cmd: 'page :5000 click "#inc"' },
    { cmd: 'page :5000 text "#n"', note: 'Read it again' },
    { cmd: 'cd /tmp/counter && git init', note: 'Commit the app' },
    { cmd: 'cd /tmp/counter && git add . && git commit -m "counter app"' },
    { cmd: 'serve stop 5000', delay: 400, note: 'Now upgrade it' },
    { cmd: "cat > /tmp/counter/index.html << 'EOF'\n" + grapherHTML + "\nEOF", note: 'Rewrite as a grapher' },
    { cmd: 'serve /tmp/counter 5000', delay: 400 },
    { cmd: 'serve open 5000 --split right', delay: 800 },
    { cmd: 'page :5000 click "#plot"', note: 'Plot the origin' },
    { cmd: 'page :5000 text "#pts"' },
    // x=3, y=2
    { cmd: 'page :5000 click "#xu"', note: 'Set x to 3' },
    { cmd: 'page :5000 click "#xu"' },
    { cmd: 'page :5000 click "#xu"' },
    { cmd: 'page :5000 click "#yu"', note: 'Set y to 2' },
    { cmd: 'page :5000 click "#yu"' },
    { cmd: 'page :5000 click "#plot"', note: 'Plot (3, 2)', delay: 500 },
    // x=7, y=5
    { cmd: 'page :5000 click "#xu"', note: 'Set x to 7' },
    { cmd: 'page :5000 click "#xu"' },
    { cmd: 'page :5000 click "#xu"' },
    { cmd: 'page :5000 click "#xu"' },
    { cmd: 'page :5000 click "#yu"', note: 'Set y to 5' },
    { cmd: 'page :5000 click "#yu"' },
    { cmd: 'page :5000 click "#yu"' },
    { cmd: 'page :5000 click "#plot"', note: 'Plot (7, 5)', delay: 500 },
    { cmd: 'page :5000 text "#pts"' },
    { cmd: 'cd /tmp/counter && git add . && git commit -m "upgrade to grapher"', note: 'Commit the upgrade' },
    { cmd: 'cd /tmp/counter && git log --oneline' },
  ];

  document.addEventListener('DOMContentLoaded', () => {
    demos.pipes = new DemoPlayer('demo-pipes', pipesSteps);
    demos.files = new DemoPlayer('demo-files', filesSteps);
    demos.text = new DemoPlayer('demo-text', textSteps);
    demos.git = new DemoPlayer('demo-git', gitSteps);
    demos.page = new DemoPlayer('demo-page', pageSteps, {
      hasPreview: true, previewId: 'preview-page',
      previewFiles: ['/tmp/site/index.html'],
    });
    demos.interact = new DemoPlayer('demo-interact', interactSteps);
    waitForShiro().catch(() => {});
  });
  </script>
</body>
</html>
